# 🎹 PyPiano -Engine

> "命运的齿轮还在转动，但这一次，咬合的齿牙间，多了一份坚定。"

![Python](https://img.shields.io/badge/Python-3.12%2B-blue) ![Pygame](https://img.shields.io/badge/Pygame-CE-green) ![Status](https://img.shields.io/badge/Status-Active-orange)

## 1. 项目来源与说明 (Introduction)

本项目基于 **A4foolU** 的原始 Python 钢琴项目进行深度开发与重构。

我们在保留其核心理念的基础上，进行了大幅度的**物理引擎化升级**：
* **双轨文本谱系统**：延续并优化了双轨（主旋律/伴奏）格式，支持更复杂的织体。
* **全键位覆盖**：支持 A0 到 C8 的完整钢琴键位。
* **声学物理模拟**：实现了**非线性力度动态**（不同触键强度的音色变化）、**物理踏板系统**（延音共振、柔音音色改变）以及断音处理。
* **高并发播放**：优化了音频混合引擎，支持多个按键并行播放不丢音。
* **零延迟加载**：改进了乐谱播放方式，增加预加载机制，消除卡顿。

## 2. 快速开始 (Quick Start)

### 🛠️ 环境准备
请确保您的电脑已安装 **Python 3.12** 或 **3.13**。

1.  **安装依赖库**
    ```bash
    pip install pygame numpy
    ```

2.  **搭建目录结构**
    下载本项目后，请务必按照以下结构整理文件夹（尤其是资源文件）：

    ```text
    PyPiano-Root/
    ├── main.py                # 主程序入口
    ├── playPiano.py           # 音频引擎核心
    └── resources/             # [核心资源文件夹]
        ├── notes/             # 存放您的乐谱文件 (.notes / .accompaniments)
        └── sounds/            # 存放钢琴音源采样 (.wav)
    ```

3.  **获取音源**
    * 本项目不直接提供大型音频文件。
    * 推荐下载 **Salamander Grand Piano** 采样库（或其他 .wav 格式采样）。
    * 解压后，将所有 `.wav` 文件放入上述的 `resources/sounds/` 文件夹中。

4.  **运行**
    ```bash
    python main.py
    ```

---

## 3. 乐谱编写指南 (Scoring Guide)

本项目使用独创的**文本谱**格式，无需五线谱基础即可创作。

### 📂 文件结构
每首歌必须包含两个文件，且**行数必须严格对齐**（时间轴同步）：
1.  **主旋律文件**：`歌名_速度.notes`
2.  **伴奏文件**：`歌名_速度.accompaniments`

> **注意**：文件名中的“速度”代表**步长 (ms/step)**。
> *例如 `paper_260.notes` 代表每行代码对应 260毫秒的时值。*

### 🎵 语法详解

#### 基础音符
* **音名**：使用国际标准音名（支持升降号）。
    * 例：`C4` (中央C), `F#3` (升F3), `Bb2` (降B2)。
* **力度**：在音符后加 `@` 和数字 `1-16` 指定触键强度。
    * 例：`C4@6` (轻柔), `G5@14` (爆发)。

#### 时值控制
* **`0` (连奏/保持)**：
    * 表示这一拍不弹新音，而是按住上一拍的音符不放，声音延续。
* **`_` (休止/断奏)**：
    * 表示手指离开琴键，制音器落下，声音截止。

#### 物理踏板 (Pedals)
* **延音踏板 (Sustain)**
    * `P+`：踩下踏板（开启全局共振）。
    * `P-`：抬起踏板（切断余音）。
* **柔音踏板 (Soft/Una Corda)**
    * `U+`：踩下柔音踏板（音色变暗，音量衰减）。
    * `U-`：松开柔音踏板（恢复正常）。

#### ⚡ 复合指令 (高级技巧)
使用 `|` 符号连接同一时刻发生的多个动作。

> **经典用法（换踏技巧）**：
> `P-|P+|C3@10`
> *含义*：先抬起踏板(P-)切断上一小节的混响 -> 再瞬间踩下踏板(P+) -> 同时弹奏 C3。这是让钢琴声清晰不浑浊的关键。

---

## 4. 谱例展示 (Example)

**文件名**: `demo_300.notes`

```text
// 纸短情长片段
P+|U+|C3@5     // 踩下双踏板，轻柔弹奏C3
G4@8           // 旋律音
0              // 保持
_              // 呼吸/休止
P-|P+|G3@10    // 换踏，弹奏G3
