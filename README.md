# 🎹 PyPiano Engine v6.0

> *"命运的齿轮还在转动，但这一次，咬合的齿牙间，多了一份坚定。"*

一台用 Python 构建的**声学物理虚拟钢琴**。基于 [A4foolU](https://github.com/A4foolU) 的原始项目深度重构，从简单的 MIDI 播放器进化为具有真实声学特性的演奏引擎。

---

## ✨ 核心特性

### 🕐 绝对时间调度
抛弃传统逐行扫描。采用 `perf_counter` 纳秒级时间戳，完美支持 **3 对 4 复节奏**（Polyrhythm）——右手三连音与左手十六分音符各走各的时间轴，互不干扰。

### 🎯 非线性力度系统
支持 4 种力度曲线（指数 / S 型 / 对数 / 线性），搭配手臂惯性模拟（Velocity Momentum），力度不再是冰冷的离散数字，而是具有物理连贯性的动态变化。

### 🔊 物理声学模型
- **琴弦共振**（Sympathetic Resonance）：未止音琴弦间的泛音共振
- **半踏板**（Half-Pedal）：连续踏板深度 0.0 → 1.0，不是简单开关
- **释键采样**（Release Samples）：制音器回落的物理噪声
- **等功率交叉淡入**：消除力度层之间的音量凹陷

### 🎼 高级演奏技巧
原生支持三连音（Tuplet）、琶音（Arpeggio）、刮奏（Glissando）、倚音（Grace Note）——全部通过谱面标记触发，无需修改代码。

---

## 🛠️ 快速开始

### 环境要求

- Python 3.12 或 3.13
- 依赖：`pip install pygame numpy`

### 目录结构

```
PyPiano-Root/
├── main.py              # 主程序入口 & 参数配置中心
├── playPiano.py         # v6.0 音频物理引擎核心 (1850+ 行)
└── resources/
    ├── notes/           # 乐谱文件 (.notes + .accompaniments)
    └── sounds/          # .wav 钢琴采样 (按力度层组织)
```

### 运行

```bash
python main.py
```

---

## 📝 乐谱编写指南

### 文件配对规则

每首乐曲由**两个行数严格对齐**的文件组成：

| 文件 | 角色 | 示例 |
|------|------|------|
| `歌名_速度.notes` | 右手 / 主旋律 | `hongdou_263.notes` |
| `歌名_速度.accompaniments` | 左手 / 伴奏 | `hongdou_263.accompaniments` |

文件名中的数字 = 每步时长（ms）。`263` 对应 ♩=57 BPM 的十六分音符精度。

> 两个文件每一行的 token 数必须完全一致，程序逐步同步播放。

---

### 🎵 音符表示

支持**简谱**和**国际音名**两种写法，可在同一行内混用。

#### 简谱写法（推荐）

| 写法 | 含义 | MIDI |
|------|------|------|
| `1` ~ `7` | C4 大调音阶 Do Re Mi Fa Sol La Si | 60~71 |
| `1+` `2+` | 高八度：C5, D5 | 72, 74 |
| `1-` `5-` | 低八度：C3, G3 | 48, 55 |
| `1++` `3--` | 倍高/倍低：C6, E2 | 84, 40 |
| `1+@14` | 力度 1-16（14=强奏） | — |
| `3@6` | 力度 6（弱奏） | — |

#### 国际音名写法

| 写法 | 含义 |
|------|------|
| `C4` `F#3` `Bb2` | 标准音名 + 八度 |
| `Eb5@12` | 降 E5，力度 12 |
| `F#4@8` | 升 F4，力度 8 |

> **变化音规则：** 简谱写法不支持升降号。遇到 `#4`（升 Fa）或 `b3`（降 Mi）时，必须切换为音名写法：`F#4@8`、`Eb5@12`。

---

### ⏱️ 时值与延音

| 符号 | 含义 | 说明 |
|------|------|------|
| `0` 或 `.` | 延音（保持） | 前一个音继续响，手指不离键 |
| `_` | 休止符 | 静音，无动作 |
| `0!` | 强制阻断 | 立刻切断声音（跳音 Staccato） |

> `0` 和 `.` 完全等价。推荐在三连音的占位符中使用 `.` 以提高可读性。

---

### 🎶 和弦

方括号 `[]` 包裹多个音符，同时发声：

```
[1, 3, 5]              // C 大三和弦
[1+@12, 3+@10, 5+@8]   // 每个音独立力度（突出旋律音）
[C4@8, E4@8, G4@8]      // 音名写法
```

---

### 🔁 三连音与复杂节奏（Tuplet）

花括号 `{}` 包裹音符，分号 `;` 分隔，后面用 `.` 撑开时间容器。

**核心公式：N 个音均匀填满 `{} + 点号` 的总步数。**

```
{1+; 2+; 3+} .            // 3 音占 2 步（十六分三连音）
{1+; 2+; 3+} . . .        // 3 音占 4 步（八分三连音，最常用）⭐
{1+; 2+; 3+} . . . . . . .  // 3 音占 8 步（四分三连音）
```

**和弦三连音：**

```
// "相聚离" —— 红豆副歌经典三连音
{[7+@13,3+@12]; [6+@12,3+@12]; [5+@12,3+@12]} . . .
```

**时间计算（♩=57, step=263ms）：**

```
八分三连: 4 步 × 263ms = 1052ms ÷ 3 = 350.7ms/音 (完美 ⅓ 分割)

时间线:
0ms      350.7ms    701.3ms    1052ms
♪相       ♪聚        ♪离        ♪下一拍
```

**3 对 4 复节奏（Polyrhythm）自动合并：**

当右手三连音和左手十六分音符同时出现时，引擎自动将两个声部的事件按时间排序后依次触发：

```
  0.0ms   右手 ♪相  +  左手 ♪步1
263.0ms                 左手 ♪步2
350.7ms   右手 ♪聚
526.0ms                 左手 ♪步3
701.3ms   右手 ♪离
789.0ms                 左手 ♪步4
1052ms    → 下一拍
```

> **口诀：** `{}` 决定弹什么，后面的 `.` 决定弹多慢。八分三连 = 3 个点。

---

### 🌊 琶音（Arpeggio）

和弦前加波浪号 `~`，音符自动按音高从低到高依次弹出：

```
~[1, 3, 5]@10            // C4→E4→G4，每隔 35ms 依次触发
~[6@8, 3@8, 1@8]         // 自动排序为 C4→E4→A4
P-|P+|~[1-@5, 3-@5, 5-@5]  // 踏板 + 琶音组合
```

**效果：** 4 音和弦的展开时间 = 3 × 35ms = 105ms，远小于一步（263ms），不影响节拍。

**参数可调：** `main.py` 中 `arpeggio_stagger_ms=35.0`，改小更急促，改大更悠缓。

**倚音（Grace Note）：** 利用琶音的微延迟特性实现：`~[b3, 3]`（降 Mi 极快滑向 Mi，蓝调风格）。

---

### 🎸 刮奏（Glissando）

利用长连音实现快速扫键：

```
{1; 2; 3; 4; 5; 6; 7; 1+; 2+; 3+} . . .
// 10 个音均匀填入 4 步时间 = 每音 105.2ms
```

---

### 🦶 踏板系统

用 `|` 分隔多个指令，在同一步内执行：

| 指令 | 功能 |
|------|------|
| `P+` | 延音踏板踩下（共振开启） |
| `P-` | 延音踏板抬起（止音） |
| `PH0.5` | 半踏板（0.0~1.0 连续深度） |
| `U+` | 柔音踏板踩下（音色变暗） |
| `U-` | 柔音踏板抬起 |

**换踏板技巧（Syncopated Pedal）：**

```
P-|P+|1--@12     // 弹新低音的瞬间：先抬踏板清掉混响 → 立刻踩下
```

> 这是钢琴家最基本的踏板技巧。`P-` 和 `P+` 在同一步内完成，旧音消失、新音立即被踏板捕获。

---

## ⚙️ 参数配置

所有参数在 `main.py` 的 `PianoSequencer()` 构造中调整：

### 核心参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `times` | `263` | 每步时长 ms（决定 BPM） |
| `main_gain` | `1.0` | 右手音量 |
| `acc_gain` | `0.75` | 左手音量 |

### 力度与动态

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `vel_crossfade` | `True` | 等功率力度层交叉淡入 |
| `vel_jitter` | `0.35` | 力度随机偏移（高斯分布） |
| `gain_jitter` | `0.02` | 音量微扰 |
| `velocity_curve` | `1.8` | 力度曲线强度 |
| `velocity_curve_type` | `exponential` | 曲线类型（exponential/s-curve/logarithmic/linear） |
| `velocity_momentum` | `0.07` | 手臂惯性（0=无, 1=极重） |

### 人性化

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `timing_jitter_ms` | `1.0` | 微时序抖动 ±ms |
| `tempo_drift_range` | `0.0` | 整体速度漂移 ±%（0.04=±4%） |
| `tempo_drift_speed` | `0.3` | 漂移速率（0.1=慢呼吸, 1.0=快摆） |
| `phrase_accel` | `0.0` | 乐句呼吸（句首微赶, 句尾微拖） |

### 物理模型

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `sympathetic_resonance` | `False` | 琴弦共振 |
| `resonance_gain` | `0.028` | 共振音量（源音量的 2.8%） |
| `half_pedal_damping` | `0.5` | 半踏板阻尼系数 |
| `repedal_window_ms` | `85` | 换踏板窗口 ms |

### 音色变化

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `round_robin` | `False` | 同音重复时微变音色 |
| `round_robin_cents` | `3.0` | 音高偏移 ±cents |
| `round_robin_offset_ms` | `8.0` | 采样起始点偏移 ms |
| `adaptive_legato` | `False` | 根据音程动态调整 overlap |
| `arpeggio_stagger_ms` | `35.0` | 琶音每音间隔 ms |

### 音频引擎

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `num_mixer_channels` | `384` | 混音器通道数 |
| `audio_buffer` | `512` | 音频缓冲区大小 |
| `release_fade_ms` | `140` | 释键淡出 ms |
| `overlap_ms` | `60` | 连奏重叠 ms |

---

## 📖 谱例

### 红豆（王菲）—— 副歌片段

**`hongdou_263.notes`**（右手）：

```
// "相聚离" 三连音 + "开" 四分音符
{[7+@13,3+@12];[6+@12,3+@12];[5+@12,3+@12]} . . . [6+@12,3+@12,1+@12] . . .
```

**`hongdou_263.accompaniments`**（左手）：

```
// 同一时间段的 Alberti bass — 正常十六分音符
P-|P+|6--@6 3-@5 6-@5 3-@5 5--@6 3-@5 5-@5 3-@5
```

### 高级技巧演示

```
// 琶音 + 踏板
P-|P+|~[1-@10, 3-@8, 5-@8, 1@7] . . .

// 刮奏 (10音快扫)
{1; 2; 3; 4; 5; 6; 7; 1+; 2+; 3+} . . .

// 跳音 (Staccato)
1+@14 0! _

// 倚音 (Grace Note)
~[Eb4, E4]@10 . . .

// 半踏板渐变
PH0.3 . PH0.5 . PH0.8 . P+ .
```

---

## 🧬 技术架构

```
main.py
  │
  ▼
PianoSequencer (Thread)
  ├── SampleLibrary        LRU 缓存 + 立体声力度层管理
  │     ├── get_sound_blend()    等功率交叉淡入 (cos/sin)
  │     └── _pitch_shift_sound() 三次插值变调
  ├── _flatten()            谱面 → 步进序列
  ├── play()                主循环 (while + perf_counter)
  │     ├── 三层 Rubato     漂移 + 乐句呼吸 + 微抖动
  │     ├── Tuplet Handler  合并时间线 + 精确子步进
  │     └── Normal Step     踏板 → 力度 → 采样 → 播放
  ├── _press_notes()        力度曲线 + 惯性 + Round Robin + 琶音
  ├── _apply_pedal()        延音 / 半踏板 / 换踏板窗口
  └── _play_sympathetic_resonance()  泛音共振
```

---

## 📜 更新日志

### v6.0（当前版本）

- **三连音引擎**：`{A;B;C}` 语法 + 双声部合并时间线（3 对 4 复节奏）
- **琶音引擎**：`~[chord]` 语法 + `threading.Timer` 微延迟 + 自动音高排序
- **踏板重构**：`pedal_actions` 列表取代单值，支持 `P-|P+|note` 复合指令
- **延音符号**：`.` 与 `0` 等价，提高三连音可读性
- **`_play_one_step` 抽取**：统一的单步播放逻辑，主循环和连音子循环复用
- **预加载扫描**：自动解析三连音子音符，确保采样预加载覆盖

### v5.x

- 等功率交叉淡入、三次插值变调、手臂惯性模拟
- 半踏板连续深度、琴弦共振、释键采样
- 三层 Rubato（漂移 + 乐句呼吸 + 微抖动）
- Round Robin 同音变化、自适应连奏
- 并行采样预加载

---

## 🙏 致谢

- 原始项目：[A4foolU/python-piano](https://github.com/A4foolU)
- 音频引擎：[Pygame](https://www.pygame.org/)
- 采样资源：Salamander Grand Piano
- 特别致谢：Bilibili--Customshop_

---

<p align="center"><i>每一个 0 都是一次呼吸，每一个 P+ 都是一次拥抱。</i></
